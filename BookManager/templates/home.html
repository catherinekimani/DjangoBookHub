{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
	{% if not user.is_authenticated %}
	{# Anonymous user view #}
	<div class="row justify-content-center mb-4">
		<div class="col-lg-8">
			<div class="bg-white rounded-3 p-4 shadow-sm">
				<h1 class="h2 mb-2">Find a book worth your time</h1>
				<p class="text-muted mb-3">Search by topic, author, or genre. <strong>You'll read on Google Books preview,
						Kindle, or a physical book</strong> — BookHub helps you save what's next and keep notes as you go.</p>

				<form class="d-flex gap-2" action="{% url 'BookManager:search' %}" method="get">
					<input type="text" name="q" class="form-control form-control-lg"
						placeholder="Search for books (e.g., negotiation, python, habit building)" autofocus>
					<button type="submit" class="btn btn-primary btn-lg">Search</button>
				</form>
			</div>
		</div>
	</div>

	{# Discover books for anonymous users #}
	{% if books %}
	<div class="mb-5">
		<h3 class="h5 mb-3">Discover Books</h3>
		<div class="row">
			{% for book in books|slice:":6" %}
			{% if book.id %}
			<div class="col-md-4 mb-4">
				<div class="card h-100">
					{% if book.cover_image %}
					<a href="{% url 'BookManager:book_detail' book.id %}">
						<img src="{{ book.cover_image }}" class="card-img-top" alt="{{ book.title }} cover"
							style="height: 220px; object-fit: cover;">
					</a>
					{% endif %}
					<div class="card-body">
						<h5 class="card-title">
							<a href="{% url 'BookManager:book_detail' book.id %}" class="text-decoration-none">{{ book.title }}</a>
						</h5>
						{% if book.authors %}
						<p class="text-muted small">by {{ book.authors }}</p>
						{% endif %}
					</div>
				</div>
			</div>
			{% endif %}
			{% endfor %}
		</div>
	</div>
	{% endif %}

	{% else %}
	{# Logged-in user view #}

	{# Continue Reading Section #}
	{% if continue_reading_book %}
	<div class="mb-5">
		<div class="card shadow-sm border-0" style="border-left: 4px solid var(--primary-color) !important;">
			<div class="row g-0">
				<div class="col-md-3">
					{% if continue_reading_book.cover_image %}
					<img src="{{ continue_reading_book.cover_image }}" class="img-fluid rounded-start h-100"
						alt="{{ continue_reading_book.title }} cover"
						style="object-fit: cover; min-height: 200px; max-height: 250px;">
					{% else %}
					<div class="bg-light rounded-start h-100 d-flex align-items-center justify-content-center"
						style="min-height: 200px;">
						<i class="bi bi-book fs-1 text-muted"></i>
					</div>
					{% endif %}
				</div>
				<div class="col-md-9">
					<div class="card-body p-4">
						<div class="d-flex justify-content-between align-items-start mb-3">
							<div>
								<p class="text-uppercase small mb-1 fw-semibold"
									style="color: var(--primary-color); letter-spacing: 0.5px;">
									<i class="bi bi-bookmark-fill me-1"></i> Continue Reading
								</p>
								<h2 class="h4 mb-2 fw-bold">{{ continue_reading_book.title }}</h2>
								{% if continue_reading_book.authors %}
								<p class="text-muted mb-0">by {{ continue_reading_book.authors }}</p>
								{% endif %}
							</div>
						</div>

						{% if continue_reading_book.description %}
						<p class="text-secondary mb-4" style="line-height: 1.6;">{{continue_reading_book.description|truncatewords:25 }}</p>
						{% endif %}

						<div class="d-flex gap-2 flex-wrap">
							<a href="{{ continue_reading_book.preview_link }}" class="btn btn-primary" target="_blank">
								<i class="bi bi-book-half"></i> Open Preview
							</a>
							<a href="{% url 'BookManager:add_reading_note' continue_reading_book.id %}" class="btn btn-success">
								<i class="bi bi-pencil-square"></i> Add Note
							</a>
							<a href="{% url 'BookManager:book_detail' continue_reading_book.id %}" class="btn btn-outline-secondary">
								View Details
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	{% endif %}

	{# Recent Notes #}
	{% if recent_notes %}
	<div class="mb-5">
		<div class="d-flex justify-content-between align-items-center mb-3">
			<h3 class="h5 mb-0">Your Recent Notes <span class="badge bg-secondary">{{ recent_notes|length }}</span></h3>
		</div>
		<div class="row">
			{% for note in recent_notes|slice:":3" %}
			<div class="col-md-4 mb-3">
				<div class="card h-100">
					<div class="card-body">
						<div class="d-flex align-items-start mb-2">
							{% if note.book.cover_image %}
							<img src="{{ note.book.cover_image }}" alt="{{ note.book.title }}" class="me-2"
								style="width: 50px; height: 70px; object-fit: cover;">
							{% endif %}
							<div class="flex-grow-1">
								<h6 class="mb-1">{{ note.book.title }}</h6>
								<small class="text-muted"><i class="bi bi-clock"></i> {{ note.created_at|timesince }} ago</small>
							</div>
						</div>
						<p class="card-text small">{{ note.content|truncatewords:20 }}</p>
						{% if note.is_public %}
						<span class="badge bg-success"><i class="bi bi-globe"></i> Public</span>
						{% endif %}
					</div>
				</div>
			</div>
			{% endfor %}
		</div>
	</div>
	{% endif %}

	{# Quick Actions #}
	<div class="row mb-5">
		<div class="col-md-6 mb-3">
			<div class="card text-center h-100">
				<div class="card-body">
					<i class="bi bi-list-ul fs-1 text-primary mb-3"></i>
					<h5 class="card-title">My Reading List</h5>
					{% if reading_list_count %}
					<p class="text-muted">{{ reading_list_count }} books</p>
					{% endif %}
					<a href="{% url 'BookManager:search' %}" class="btn btn-outline-primary">Browse Books</a>
				</div>
			</div>
		</div>
		<div class="col-md-6 mb-3">
			<div class="card text-center h-100">
				<div class="card-body">
					<i class="bi bi-journal-text fs-1 text-success mb-3"></i>
					<h5 class="card-title">Your Notes</h5>
					{% if recent_notes %}
					<p class="text-muted">{{ recent_notes|length }} recent notes</p>
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	{# Discover New Books #}
	{% if books %}
	<div class="mb-5">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<h3 class="h4 mb-0">
				<i class="bi bi-compass"></i> Discover New Books
			</h3>
			<a href="{% url 'BookManager:search' %}" class="text-decoration-none">
				View All <i class="bi bi-arrow-right"></i>
			</a>
		</div>

		<div class="row g-3">
			{% for book in books|slice:":6" %}
			{% if book.id %}
			<div class="col-12">
				<div class="card book-card border-0 shadow-sm h-100">
					<div class="row g-0">
						<div class="col-md-2 col-lg-1">
							{% if book.cover_image %}
							<a href="{% url 'BookManager:book_detail' book.id %}">
								<img src="{{ book.cover_image }}" class="img-fluid rounded-start" alt="{{ book.title }} cover"
									style="height: 140px; width: 100%; object-fit: cover;">
							</a>
							{% else %}
							<div class="bg-light rounded-start d-flex align-items-center justify-content-center"
								style="height: 140px;">
								<i class="bi bi-book fs-3 text-muted"></i>
							</div>
							{% endif %}
						</div>
						<div class="col-md-10 col-lg-11">
							<div class="card-body p-3">
								<div class="d-flex justify-content-between align-items-start mb-2">
									<div class="flex-grow-1">
										<h5 class="card-title mb-1 fw-bold">
											<a href="{% url 'BookManager:book_detail' book.id %}" class="text-decoration-none"
												style="color: var(--primary-color);">
												{{ book.title }}
											</a>
										</h5>
										{% if book.authors %}
										<p class="text-muted small mb-2">
											<i class="bi bi-person"></i> {{ book.authors }}
										</p>
										{% endif %}
									</div>
								</div>

								{% if book.description %}
								<p class="card-text text-secondary mb-3"
									style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5;">
									{{ book.description }}
								</p>
								{% else %}
								<p class="card-text text-muted fst-italic mb-3">No description available</p>
								{% endif %}

								<div class="d-flex gap-2 flex-wrap">
									<a href="{% url 'BookManager:book_detail' book.id %}" class="btn btn-sm btn-primary">
										<i class="bi bi-eye"></i> View Details
									</a>
									<button class="btn btn-sm btn-outline-secondary toggle-favorite" data-book-id="{{ book.id }}">
										<span class="favorite-icon">♡</span> Favorite
									</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			{% endif %}
			{% empty %}
			<div class="col-12">
				<p class="text-center text-muted">No books available to discover.</p>
			</div>
			{% endfor %}
		</div>
	</div>
	{% endif %}

	{% endif %}
</div>


{% if user.is_authenticated %}
<script type="module" src="{% static 'js/book-interactions.js' %}"></script>
{% endif %}
{% endblock %}